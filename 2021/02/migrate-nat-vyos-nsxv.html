<!DOCTYPE html>
<html lang="fr" prefix="og: http://ogp.me/ns#">
<head>
  <meta charset="UTF-8" />
  <title>Migrer des règles de NAT VyOS vers NSX-V | ADX - Le Blog</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i%7CSource+Code+Pro:400,400i,600" />
  <link rel="stylesheet" href="https://blog.devarieux.net/static/m-dark.css" />
  <link rel="canonical" href="https://blog.devarieux.net/2021/02/migrate-nat-vyos-nsxv.html" />
  <link href="https://blog.devarieux.net/feed/atom.xml" type="application/atom+xml" rel="alternate" title="ADX - Le Blog" />
  <link href="https://blog.devarieux.net/feed/reseau.atom.xml" type="application/atom+xml" rel="alternate" title="ADX - Le Blog | Réseau" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
  <meta property="og:site_name" content="ADX - Le Blog" />
  <meta property="og:title" content="Migrer des règles de NAT VyOS vers NSX-V" />
  <meta name="twitter:title" content="Migrer des règles de NAT VyOS vers NSX-V" />
  <meta property="og:url" content="https://blog.devarieux.net/2021/02/migrate-nat-vyos-nsxv.html" />
  <meta property="og:description" content="Il y a quelques temps, j&#39;ai procédé une modification majeure de l&#39;architecture BGP d&#39;un hébergeur. Cette modification imposait de transposer les règles de NAT présentent sur les routeurs BGP VyOS vers les routeurs NSX-V, plus proche du coeur de réseau. Il y avait environ 400 règles de NAT à transposer …" />
  <meta name="twitter:description" content="Il y a quelques temps, j&#39;ai procédé une modification majeure de l&#39;architecture BGP d&#39;un hébergeur. Cette modification imposait de transposer les règles de NAT présentent sur les routeurs BGP VyOS vers les routeurs NSX-V, plus proche du coeur de réseau. Il y avait environ 400 règles de NAT à transposer …" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:type" content="article" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a href="../../" id="m-navbar-brand" class="m-col-t-9 m-col-m-none m-left-m">ADX</a>
      <a id="m-navbar-show" href="#navigation" title="Show navigation" class="m-col-t-3 m-hide-m m-text-right"></a>
      <a id="m-navbar-hide" href="#" title="Hide navigation" class="m-col-t-3 m-hide-m m-text-right"></a>
      <div id="m-navbar-collapse" class="m-col-t-12 m-show-m m-col-m-none m-right-m">
        <div class="m-row">
          <ol class="m-col-t-12 m-col-m-none">
            <li><a href="https://blog.devarieux.net/pages/about.html">About</a></li>
            <li><a href="https://twitter.com/landvarx">Twitter</a></li>
            <li><a href="https://www.linkedin.com/in/alain-devarieux/">LinkedIn</a></li>
            <li><a href="https://noc.social/@Landvarx">Mastodon</a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main>
<div class="m-container">
  <div class="m-row">
    <article class="m-col-m-10 m-nopadb">
      <header>
        <h1><a href="https://blog.devarieux.net/2021/02/migrate-nat-vyos-nsxv.html" rel="bookmark" title="Permalink to Migrer des règles de NAT VyOS vers NSX-V">
          <time class="m-date" datetime="2021-02-10T09:22:00+01:00">
            Feb <span class="m-date-day">10</span> 2021
          </time>
          Migrer des règles de NAT VyOS vers NSX-V
        </a></h1>
        <p>Il y a quelques temps, j'ai procédé une modification majeure de l'architecture BGP d'un hébergeur. Cette modification imposait de transposer les règles de NAT présentent sur les routeurs BGP VyOS vers les routeurs NSX-V, plus proche du coeur de réseau.
        Il y avait environ 400 règles de NAT à transposer …</p>
      </header>
      <div class="m-clearfix-l"></div>
<!-- content -->
<p>Il y a quelques temps, j'ai procédé une modification majeure de l'architecture BGP d'un hébergeur. Cette modification imposait de transposer les règles de NAT présentent sur les routeurs BGP VyOS vers les routeurs NSX-V, plus proche du coeur de réseau.
Il y avait environ 400 règles de NAT à transposer. Ceux qui ont déjà fait du NAT sur NSX savent que réaliser ce genre de manipulation manuellement n'est pas une sinécure. L'interface n'est clairement pas adaptée pour ce genre de tâche. Par contre, NSX dispose d'une API plutot bien documentée.
De l'autre coté, VyOS. VyOS est un système d'exploitation réseau, basé sur Debian avec des commandes similaires à ce qu'on peut trouver sur un routeur.</p>
<p>En discutant avec <a href="https://baturin.org/">Daniil Baturin</a>, principal mainteneur de VyOS, sur la meilleur façon de procéder, celui ci m'a indiqué la <a href="https://github.com/vyos/vyos-1x/blob/current/python/vyos/configtree.py">lib configtree</a> qui permet de manipuler un fichier de configuration VyOS. Avec l'aide de cette lib, j'ai pu écrire ce script Python qui lit le fichier vyos.conf préalablement récupéré par mes soins et génére puis pousse les règles de NAT vers NSX-V.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span>  <span class="kn">import</span> <span class="nn">vyos.configtree</span>
  <span class="kn">import</span> <span class="nn">requests</span>
  <span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>

  <span class="c1"># Set variables for edg_id and nsxmanager</span>
  <span class="n">edge_id</span> <span class="o">=</span> <span class="s1">&#39;edge-XXX&#39;</span>
  <span class="n">nsx_manager</span> <span class="o">=</span> <span class="s1">&#39;nsxmanager.localdomain&#39;</span>

  <span class="k">def</span> <span class="nf">get_nat_dest_rule</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
      <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      From VyOS config section &quot;nat destination rule X&quot;</span>
<span class="sd">      Return the DNAT rule X as dict</span>
<span class="sd">      &#39;&#39;&#39;</span>
      <span class="n">rule</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;dstaddr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;srcaddr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;inbound-interface&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;inbound-interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;inbound-interface&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;translateaddr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">])</span>

      <span class="k">return</span> <span class="n">rule</span>

  <span class="k">def</span> <span class="nf">get_nat_source_rule</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
      <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      From VyOS config section &quot;nat source rule X&quot;</span>
<span class="sd">      Return the SNAT rule X as dict</span>
<span class="sd">      &#39;&#39;&#39;</span>
      <span class="n">rule</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;srcaddr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;dstaddr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;outbound-interface&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;outbound-interface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;outbound-interface&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">]):</span>
          <span class="n">rule</span><span class="p">[</span><span class="s2">&quot;translateaddr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">])</span>

      <span class="k">return</span> <span class="n">rule</span>

  <span class="k">def</span> <span class="nf">create_dstnat_payload</span><span class="p">(</span><span class="n">natdst</span><span class="p">):</span>
      <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      From all VyOS DNAT rules, create a XML payload that can be sent to NSX</span>
<span class="sd">      &#39;&#39;&#39;</span>
      <span class="n">start_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;natRules&gt;&quot;</span>
      <span class="n">end_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;/natRules&gt;&quot;</span>
      <span class="n">mid_payload</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
      <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">natdst</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="n">base_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;natRule&gt;&lt;action&gt;dnat&lt;/action&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;originalAddress&gt;</span><span class="si">{0}</span><span class="s2">&lt;/originalAddress&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;translatedAddress&gt;</span><span class="si">{1}</span><span class="s2">&lt;/translatedAddress&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;loggingEnabled&gt;false&lt;/loggingEnabled&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;enabled&gt;true&lt;/enabled&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;originalPort&gt;any&lt;/originalPort&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;translatedPort&gt;any&lt;/translatedPort&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;dstaddr&#39;</span><span class="p">],</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;translateaddr&#39;</span><span class="p">])</span>
          <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
              <span class="n">descr_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;description&gt;</span><span class="si">{0}</span><span class="s2">&lt;/description&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
              <span class="n">base_payload</span> <span class="o">=</span> <span class="n">base_payload</span> <span class="o">+</span> <span class="n">descr_payload</span>
          <span class="k">if</span> <span class="s2">&quot;protocol&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                  <span class="n">proto_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;protocol&gt;any&lt;/protocol&gt;&quot;</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">proto_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;protocol&gt;</span><span class="si">{0}</span><span class="s2">&lt;/protocol&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">])</span>

          <span class="k">else</span><span class="p">:</span>
              <span class="n">proto_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;protocol&gt;any&lt;/protocol&gt;&quot;</span>
          <span class="n">base_payload</span> <span class="o">=</span> <span class="n">base_payload</span> <span class="o">+</span> <span class="n">proto_payload</span>
          <span class="k">if</span> <span class="s2">&quot;srcaddr&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
              <span class="n">src_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;dnatMatchSourceAddress&gt;</span><span class="si">{0}</span><span class="s2">&lt;/dnatMatchSourceAddress&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;srcaddr&#39;</span><span class="p">])</span>
              <span class="n">base_payload</span> <span class="o">=</span> <span class="n">base_payload</span> <span class="o">+</span> <span class="n">src_payload</span>

          <span class="n">mid_payload</span> <span class="o">=</span> <span class="n">mid_payload</span> <span class="o">+</span> <span class="n">base_payload</span> <span class="o">+</span> <span class="s2">&quot;&lt;/natRule&gt;&quot;</span>

      <span class="n">payload</span> <span class="o">=</span> <span class="n">start_payload</span> <span class="o">+</span> <span class="n">mid_payload</span> <span class="o">+</span> <span class="n">end_payload</span>
      <span class="k">return</span> <span class="n">payload</span>

  <span class="k">def</span> <span class="nf">create_srcnat_payload</span><span class="p">(</span><span class="n">natsrc</span><span class="p">):</span>
      <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      From all VyOS SNAT rules, create a XML payload that can be sent to NSX</span>
<span class="sd">      &#39;&#39;&#39;</span>
      <span class="n">start_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;natRules&gt;&quot;</span>
      <span class="n">end_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;/natRules&gt;&quot;</span>
      <span class="n">mid_payload</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
      <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">natsrc</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
          <span class="n">base_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;natRule&gt;&lt;action&gt;snat&lt;/action&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;originalAddress&gt;</span><span class="si">{0}</span><span class="s2">&lt;/originalAddress&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;translatedAddress&gt;</span><span class="si">{1}</span><span class="s2">&lt;/translatedAddress&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;loggingEnabled&gt;false&lt;/loggingEnabled&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;enabled&gt;true&lt;/enabled&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;originalPort&gt;any&lt;/originalPort&gt;</span><span class="se">\</span>
<span class="s2">                          &lt;translatedPort&gt;any&lt;/translatedPort&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;srcaddr&#39;</span><span class="p">],</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;translateaddr&#39;</span><span class="p">])</span>
          <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
              <span class="n">descr_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;description&gt;</span><span class="si">{0}</span><span class="s2">&lt;/description&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
              <span class="n">base_payload</span> <span class="o">=</span> <span class="n">base_payload</span> <span class="o">+</span> <span class="n">descr_payload</span>
          <span class="k">if</span> <span class="s2">&quot;protocol&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                  <span class="n">proto_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;protocol&gt;any&lt;/protocol&gt;&quot;</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">proto_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;protocol&gt;</span><span class="si">{0}</span><span class="s2">&lt;/protocol&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">])</span>

          <span class="k">else</span><span class="p">:</span>
              <span class="n">proto_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;protocol&gt;any&lt;/protocol&gt;&quot;</span>
          <span class="n">base_payload</span> <span class="o">=</span> <span class="n">base_payload</span> <span class="o">+</span> <span class="n">proto_payload</span>
          <span class="k">if</span> <span class="s2">&quot;dstaddr&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
              <span class="n">src_payload</span> <span class="o">=</span> <span class="s2">&quot;&lt;snatMatchDestinationAddress&gt;</span><span class="si">{0}</span><span class="s2">&lt;/snatMatchDestinationAddress&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;dstaddr&#39;</span><span class="p">])</span>
              <span class="n">base_payload</span> <span class="o">=</span> <span class="n">base_payload</span> <span class="o">+</span> <span class="n">src_payload</span>

          <span class="n">mid_payload</span> <span class="o">=</span> <span class="n">mid_payload</span> <span class="o">+</span> <span class="n">base_payload</span> <span class="o">+</span> <span class="s2">&quot;&lt;/natRule&gt;&quot;</span>

      <span class="n">payload</span> <span class="o">=</span> <span class="n">start_payload</span> <span class="o">+</span> <span class="n">mid_payload</span> <span class="o">+</span> <span class="n">end_payload</span>
      <span class="k">return</span> <span class="n">payload</span>

  <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;vyos.conf&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
          <span class="n">config_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">config</span> <span class="o">=</span> <span class="n">vyos</span><span class="o">.</span><span class="n">configtree</span><span class="o">.</span><span class="n">ConfigTree</span><span class="p">(</span><span class="n">config_string</span><span class="p">)</span>

      <span class="c1"># We start with DNAT rules</span>
      <span class="n">destrulesid</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">list_nodes</span><span class="p">([</span><span class="s2">&quot;nat&quot;</span><span class="p">,</span> <span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="s2">&quot;rule&quot;</span><span class="p">])</span>
      <span class="n">natdest_all</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">destruleid</span> <span class="ow">in</span> <span class="n">destrulesid</span><span class="p">:</span>
          <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">          We build a huge DNAT dict where keys are rules id and items are dict of rule parameter :</span>
<span class="sd">          &#39;1&#39;: {&#39;dstaddr&#39;: &#39;1.2.3.4&#39;,</span>
<span class="sd">                &#39;outbound-interface&#39;: &#39;eth1&#39;,</span>
<span class="sd">                &#39;log&#39;: &#39;enable&#39;,</span>
<span class="sd">                &#39;protocol&#39;: &#39;all&#39;,</span>
<span class="sd">                &#39;translateaddr&#39;: &#39;10.1.2.3&#39;}</span>
<span class="sd">          &#39;&#39;&#39;</span>
          <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nat&quot;</span><span class="p">,</span> <span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="s2">&quot;rule </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">destruleid</span><span class="p">)]</span>
          <span class="n">natdest</span> <span class="o">=</span> <span class="n">get_nat_dest_rule</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
          <span class="n">natdest_all</span><span class="p">[</span><span class="n">destruleid</span><span class="p">]</span> <span class="o">=</span> <span class="n">natdest</span>
      <span class="c1">#print(natdest_all)</span>

      <span class="c1"># Continue with SNAT rules</span>
      <span class="n">srcrulesid</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">list_nodes</span><span class="p">([</span><span class="s2">&quot;nat&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;rule&quot;</span><span class="p">])</span>
      <span class="n">natsrc_all</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">srcruleid</span> <span class="ow">in</span> <span class="n">srcrulesid</span><span class="p">:</span>
          <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">          Same as the DNAT dict</span>
<span class="sd">          &#39;&#39;&#39;</span>
          <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nat&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;rule </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcruleid</span><span class="p">)]</span>
          <span class="n">srcdest</span> <span class="o">=</span> <span class="n">get_nat_source_rule</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
          <span class="n">natsrc_all</span><span class="p">[</span><span class="n">srcruleid</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcdest</span>
      <span class="c1">#print(natsrc_all)</span>

      <span class="c1"># We now have two huge dictionnaries with DNAT and SNAT rules from VyOS</span>
      <span class="c1"># We are going to process them and POST them to NSX :crossed_fingers:</span>

      <span class="c1"># Replace edge-XXX with the right edge-id</span>
      <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://</span><span class="si">{0}</span><span class="s2">/api/4.0/edges/</span><span class="si">{1}</span><span class="s2">/nat/config/rules&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsx_manager</span><span class="p">,</span> <span class="n">edge_id</span><span class="p">)</span>
      <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/xml&#39;</span>
      <span class="p">}</span>

      <span class="n">dstnat_payload</span> <span class="o">=</span> <span class="n">create_dstnat_payload</span><span class="p">(</span><span class="n">natdest_all</span><span class="p">)</span>
      <span class="n">srcnat_payload</span> <span class="o">=</span> <span class="n">create_srcnat_payload</span><span class="p">(</span><span class="n">natsrc_all</span><span class="p">)</span>

      <span class="c1"># This script is ment to be be run only once</span>
      <span class="c1"># Write your Vsphere login and password here</span>
      <span class="c1"># Don&#39;t commit your login and passord to git!!!!!!!!!</span>
      <span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>
      <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;password&#39;</span>

      <span class="c1"># POST DNAT rules</span>
      <span class="c1"># This request append the rules to the existing ones</span>
      <span class="c1">#print(dstnat_payload)</span>
      <span class="n">dstresponse</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">dstnat_payload</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">dstresponse</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">dstresponse</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>

      <span class="c1"># POST SNAT rules</span>
      <span class="c1"># This request append the rules to the existing ones</span>
      <span class="c1">#print(srcnat_payload)</span>
      <span class="n">srcresponse</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">srcnat_payload</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">srcresponse</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">srcresponse</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>

  <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
      <span class="n">main</span><span class="p">()</span>
</pre></div></td></tr></table></div>
<!-- /content -->
      <footer>
        <p>Posted by <a href="https://blog.devarieux.net/author/aldevar.html">Aldevar</a> on <time datetime="2021-02-10T09:22:00+01:00">Wed 10 February 2021</time> in <a href="https://blog.devarieux.net/category/reseau.html">Réseau</a>.</p>
      </footer>
    </article>
    <nav class="m-navpanel m-col-m-2">
      <h3>Categories</h3>
      <ol class="m-block-bar-m">
        <li><a href="https://blog.devarieux.net/category/cyber.html">Cyber</a></li>
        <li><a href="https://blog.devarieux.net/category/humeur.html">Humeur</a></li>
        <li><a href="https://blog.devarieux.net/category/none.html">None</a></li>
        <li><a href="https://blog.devarieux.net/category/reseau.html">Réseau</a></li>
        <li><a href="https://blog.devarieux.net/category/supervision.html">Supervision</a></li>
        <li><a href="https://blog.devarieux.net/category/sysadmin.html">Sysadmin</a></li>
        <li><a href="https://blog.devarieux.net/category/tech.html">Tech</a></li>
      </ol>
    </nav>
  </div>
</div>
</main>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>ADX - Le Blog. Powered by <a href="https://getpelican.com">Pelican</a> and <a href="https://mcss.mosra.cz">m.css</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>