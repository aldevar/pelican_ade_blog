<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Zabbix - Superviser un cluster Ceph
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="../../theme/css/normalize.css">
        <link href='//fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="../../theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="../../theme/css/main.css">

    <link rel="stylesheet" href="../../theme/css/blog.css">
    <link rel="stylesheet" href="../../theme/css/github.css">
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Aldevar - Le Blog Atom Feed" />
        <script src="../../theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
        <a id="site-title" href="../.."><h1><i class="icon-coffee"></i> Aldevar - Le Blog</h1></a>
        <p id="site-desc"> Un Blog IT </p>
    </hgroup>
    <nav>
        <ul id="nav-links">
        </ul>
    </nav>
<footer id="site-info">
    <p>
        Proudly powered by <a href="http://getpelican.com/" target="pelican">Pelican</a> and <a href="http://python.org/" target="python">Python</a>. Theme by <a href="https://github.com/hdra/pelican-cait" target="github">hndr</a>.
    </p>
    <p>
        Textures by <a href="http://subtlepatterns.com/" target="subtlepatterns">Subtle Pattern</a>. Font Awesome by <a href="http://fortawesome.github.io/Font-Awesome/" target="github">Dave Grandy</a>.
    </p>
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <time class="post-time" datetime="2016-07-05T21:45:00+02:00" pubdate>
                            Tue 05 July 2016
                        </time>
                        <a href="../../2016/07/zabbix-superviser-cluster-ceph.html" rel="bookmark"><h1>Zabbix - Superviser un cluster Ceph</h1></a>
                    </header>

                    <section class="post-content">
                        <p>Ceph est une solution open source de stockage distribué avec réplication
des données et une forte tolérance aux pannes. Différentes commandes
existent pour vérifier l'état du cluster et nous allons voir comment les
exploiter avec des scripts Python pour que Zabbix puisse récupérer les
métriques.</p>
<p><img alt="Ceph_Logo" src="/images/Ceph_Logo.png" /></p>
<p>Je suis parti d'un <a class="reference external" href="https://github.com/thelan/ceph-zabbix">template déjà
existant</a>, avec un script bash
qui exécute les commandes, parse la sortie et retourne la métrique
attendue. Ce script, à mon avis, a cependant un problème. A chaque
exécution,&nbsp;il exécute toutes les commandes, parse toutes les réponses et
retourne enfin la métrique attendue suivant l'argument passé en entrée.
Ce comportement peu optimisé induit que parfois, suivant la charge du
serveur, l’exécution du script peut prendre trop de temps et l'item
Zabbix tombe en timeout. Ce n'est évidemment pas un comportement que
nous souhaitons avoir.</p>
<p>Puisqu'il fallait reprendre le script, je me suis lancé dans sa complète
réécriture en Python. J'ai pu ainsi profiter du format json proposé par
les outils Ceph pour l'output des données et également du module json
inclus dans Python. Cela m'a permis de gagner du temps (pour moi et le
processeur) car je peux parser les données plus facilement. Le script
bash utilise beaucoup d'expressions régulières via sed. Dorénavant, je
n'ai qu'à appeler le bon objet json et l'afficher.</p>
<p>La version actuel du template comporte 3 scripts. Je peux encore
optimisé tout cela en 1 seul fichier, ce sera pour la prochaine version.
Le premier script nommé cephpools.py permet la découverte automatique
des pools rados Ceph. Le second, cephimages.py, permet quant à lui la
découverte automatique des images rbd de chaque pool. C'est également ce
script qui est appelé pour récupérer la taille des images.</p>
<p>Enfin, le script principal ceph-status.py s'occupe de retourner les
valeurs des métriques à &nbsp;Zabbix : état des pg, santé du cluster, IOPS,
état des mon etc.</p>
<p>Vous pouvez retrouver ces scripts et template zabbix <a class="reference external" href="https://github.com/aldevar/ceph-zabbix">sur la page github
dédiée</a></p>

                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="../../category/supervision.html">Supervision</a></p>
                        <p>Tags: <a href="../../tag/ceph.html">ceph</a>, <a href="../../tag/devops.html">devops</a>, <a href="../../tag/python.html">python</a>, <a href="../../tag/zabbix.html">zabbix</a>, </p>
                    </aside>
                    <hr/>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="../../theme/js/main.js"></script>
    </body>
</html>