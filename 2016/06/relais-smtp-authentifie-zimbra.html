<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Zimbra : Envoi de mails via un relais SMTP authentifié
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="../../theme/css/normalize.css">
        <link href='//fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="../../theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="../../theme/css/main.css">

    <link rel="stylesheet" href="../../theme/css/blog.css">
    <link rel="stylesheet" href="../../theme/css/github.css">
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Aldevar - Le Blog Atom Feed" />
        <script src="../../theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
        <a id="site-title" href="../.."><h1><i class="icon-coffee"></i> Aldevar - Le Blog</h1></a>
        <p id="site-desc"> Un Blog IT </p>
    </hgroup>
    <nav>
        <ul id="nav-links">
        </ul>
    </nav>
<footer id="site-info">
    <p>
        Proudly powered by <a href="http://getpelican.com/" target="pelican">Pelican</a> and <a href="http://python.org/" target="python">Python</a>. Theme by <a href="https://github.com/hdra/pelican-cait" target="github">hndr</a>.
    </p>
    <p>
        Textures by <a href="http://subtlepatterns.com/" target="subtlepatterns">Subtle Pattern</a>. Font Awesome by <a href="http://fortawesome.github.io/Font-Awesome/" target="github">Dave Grandy</a>.
    </p>
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <time class="post-time" datetime="2016-06-24T08:30:00+02:00" pubdate>
                            Fri 24 June 2016
                        </time>
                        <a href="../../2016/06/relais-smtp-authentifie-zimbra.html" rel="bookmark"><h1>Zimbra : Envoi de mails via un relais SMTP authentifié</h1></a>
                    </header>

                    <section class="post-content">
                        <p>Héberger soi même ses données c'est bien, le faire correctement c'est
mieux. Le problème majeur lorsqu'on souhaite héberger soi même ses mails
est qu'il est difficile de s'assurer que les mails soient bien reçus par
nos correspondants.</p>
<p>Il arrive souvent que l'IP fournie par l’hébergeur fasse partie d'un
bloc d'IP bannie par plusieurs serveur SMTP. Il est toujours possible de
se faire débloquer des principales blacklists mais la plupart des
services mails possèdent leur propre blacklist (coucou barracuda). Même
un SPF et un DKIM bien configuré ne suffisent pas à outrepasser ces
blocages.</p>
<p>Plusieurs solutions s'offraient à moi pour contourner ce problème.</p>
<ul class="simple">
<li>Changer d'adresse IP: ça peut fonctionner mais impossible de savoir
tant qu'on a pas testé la nouvelle IP. Forte &nbsp;probabilité que cette
IP fasse également partie d'un bloc blacklisté</li>
<li>Passer sur un hébergeur Zimbra : Intéressant, mais souvent très cher.
De l'ordre de 5€/mois et par compte minimum.</li>
<li>Passer par un relais SMTP : J'ai opté pour cette solution même si
elle n'est pas idéal car cela ajoute intermédiaire et une dépendance
pour le service.</li>
</ul>
<p>Pour mettre cette solution en oeuvre, j'ai choisi le service smtp2go. Il
y en a beaucoup d'autres et la plupart proposent des services gratuits
pour un envoi limité de mails. Avec smtp2go, le service est gratuit
jusqu'à 1000 mails par mois ce qui devrait être suffisant.</p>
<p>Une fois l'inscription effectuée, il faut encore configurer Zimbra pour
qu'il utilise ce relais. L'interface web d'administration propose bien
d'ajouter des relais SMTP mais impossible de s'y authentifier. La
configuration d'un relais STMP authentifié doit être faite en ligne de
commande.</p>
<pre class="literal-block">
[root&#64;monzimbra]# su - zimbra
## On ajoute le relais SMTP
[root&#64;monzimbra]# zmprov ms monzimbra.mondomaine.com&nbsp;zimbraMtaRelayHost relaissmtp.relaisdomaine.com:port
## On créé un fichier text de mapping login/mdp pour le relais
[root&#64;monzimbra]# echo relaissmtp.relaisdomaine.com USERNAME:PASSWORD &gt; /opt/zimbra/conf/relay_password
## Création de la table postfix
[root&#64;monzimbra]# postmap /opt/zimbra/conf/relay_password
## Pour tester. Cette commande doit retourner le couple login/mdp
[root&#64;monzimbra]# postmap -q relaissmtp.relaisdomaine.com /opt/zimbra/conf/relay_password
## Configuration de postfix pour qu'il utilise la map de login/mdp
[root&#64;monzimbra]# zmprov ms monzimbra.mondomaine.com zimbraMtaSmtpSaslPasswordMaps lmdb:/opt/zimbra/conf/relay_password
## Configuration de postfix pour qu'il utilise l'authentification SSL
[root&#64;monzimbra]# zmprov ms monzimbra.mondomaine.com zimbraMtaSmtpSaslAuthEnable yes
## Configuration de postfix pour qu'il n'utilise pas le canonical name du relais (problème de login/mdp sinon)
[root&#64;monzimbra]# zmproc ms monzimbra.mondomaine.com zimbraMtaSmtpCnameOverridesServername no
## Configuration de TLS
[root&#64;monzimbra]# zmprov ms monzimbra.mondomaine.com zimbraMtaSmtpTlsSecurityLevel may
</pre>
<p>C'est terminé, tous les domaines attachés au serveur passeront
dorénavant vers ce relais SMTP.</p>

                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="../../category/tech.html">Tech</a></p>
                        <p>Tags: <a href="../../tag/email.html">email</a>, <a href="../../tag/relais.html">relais</a>, <a href="../../tag/smtp.html">smtp</a>, <a href="../../tag/spam.html">spam</a>, <a href="../../tag/zimbra.html">zimbra</a>, </p>
                    </aside>
                    <hr/>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="../../theme/js/main.js"></script>
    </body>
</html>