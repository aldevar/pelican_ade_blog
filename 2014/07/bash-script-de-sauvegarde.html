<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Bash : Script de sauvegarde
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="../../theme/css/normalize.css">
        <link href='//fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="../../theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="../../theme/css/main.css">

    <link rel="stylesheet" href="../../theme/css/blog.css">
    <link rel="stylesheet" href="../../theme/css/github.css">
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Aldevar - Le Blog Atom Feed" />
        <script src="../../theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
        <a id="site-title" href="../.."><h1><i class="icon-coffee"></i> Aldevar - Le Blog</h1></a>
        <p id="site-desc"> Un Blog IT </p>
    </hgroup>
    <nav>
        <ul id="nav-links">
        </ul>
    </nav>
<footer id="site-info">
    <p>
        Proudly powered by <a href="http://getpelican.com/" target="pelican">Pelican</a> and <a href="http://python.org/" target="python">Python</a>. Theme by <a href="https://github.com/hdra/pelican-cait" target="github">hndr</a>.
    </p>
    <p>
        Textures by <a href="http://subtlepatterns.com/" target="subtlepatterns">Subtle Pattern</a>. Font Awesome by <a href="http://fortawesome.github.io/Font-Awesome/" target="github">Dave Grandy</a>.
    </p>
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <time class="post-time" datetime="2014-07-24T11:14:00+02:00" pubdate>
                            Thu 24 July 2014
                        </time>
                        <a href="../../2014/07/bash-script-de-sauvegarde.html" rel="bookmark"><h1>Bash : Script de sauvegarde</h1></a>
                    </header>

                    <section class="post-content">
                        <p>On ne le dira jamais assez : <strong>FAITES DES SAUVEGARDES!!!!!</strong>
Ayant un petit serveur dédié sous CentOS, j'ai évidemment appliqué
cet adage à moi même. Je vous présente donc un script duquel vous pouvez
librement vous inspirer afin de l'adapter à votre environnement.
Ce script place quelques répertoires et quelques exports de base de
données dans un fichier tar.gz puis envoie ce fichier sur 2 serveurs FTP
(ceinture + bretelles) et enfin déplace l'archive dans un répertoire de
<a class="reference external" href="http://pyd.io">pydio</a> afin de pouvoir facilement récupérer le
fichier sur ma machine personnelle.</p>
<pre class="literal-block">
#!/bin/bash
#Fichier de Backup créé par Alain Devarieux
# - créer un fichier tar.gz contenant plusieurs élements de l'arborescence
# - Envoie ce fichier tar.gz sur un serveur FTP dédié au backup
# - Dépose une copie du fichier tar.gz dans un repertoire local
# - Ceinture ET Bretelles : Envoie le fichier tar.gz sur un 2nd serveur FTP
logger -t backup &quot;########## Debut de la sauvegarde ##########&quot;
# Nom du fichier de Backup
backup_file=&quot;/sauv/backup-$(hostname)-$(date +%Y-%m-%d).tar.gz&quot;
#Variable : Premier Serveur FTP de Backup
bckftp01=&quot;server01&quot;
bckftp01_user=&quot;user01&quot;
bckftp01_mdp=&quot;Enter password here&quot;
#Variable : Second Serveur de Backup
bckftp02=&quot;server02&quot;
bckftp02_user=&quot;user02&quot;
bckftp02_mdp=&quot;Enter password here&quot;
#Varibales : Dossier de destination du tar.gz en local
destdir=&quot;/var/www/html/pydio/data/files/&quot;
#Liste des dossiers à sauvegarder
backup_list=&quot;/etc /var/www/html /sauv/sql /sauv/packagelist.txt&quot;
#Le dossier a exclure
backup_exclude=&quot;/var/www/html/pydio/data&quot;

#Liste des paquets installés
rpm -qa &gt; /sauv/packagelist.txt

#Dump des bases SQL
#Base01
if ! mysqldump -u userbase01 -pPassword base01 &gt; /sauv/sql/base01.sql; then
statusbase01=&quot;Warning : Erreur lors de l'export de la base Base01&quot;
else
statusbase01=&quot;Succes de l'export de la base Base01&quot;
fi
logger -t backup &quot;$statusbase01&quot;
#Base02
if ! mysqldump -u userbase02 -pPassword Base02 &gt; /sauv/sql/base02.sql; then
statusbase02=&quot;Warning : Erreur lors de l'export de la base Base02&quot;
else
statusbase02=&quot;Succes de l'export de la base Base02&quot;
fi
logger -t backup &quot;$statusbase02&quot;

#Creation du tar
#On commence par enregistrer la seconde de debut
start=$(date '+%s')
if ! tar czf $backup_file --exclude=$backup_exclude $backup_list; then
statustar=&quot;echec de la commande tar&quot; || exit 1
else
statustar=&quot;Succes creation fichier tar taille=$(stat -c%s $backup_file) duree=$((`date '+%s'` - $start))&quot;
fi
#On log le resultat
logger -t backup &quot;$statustar&quot;

#Envoie vers le ftp01
if ! lftp $bckftp01_user:$bckftp01_mdp&#64;$bckftp01 -e &quot;put $backup_file; exit&quot;; then
statusftp01=&quot;Echec de l'envoie FTP vers $bckftp01&quot;
else
statusftp01=&quot;Succes de l'envoie FTP vers $bckftp01&quot;
fi
#On log le resultat
logger -t backup &quot;$statusftp01&quot;

#Envoie vers le ftp02
if ! lftp $bckftp02_user:$bckftp02_mdp&#64;$bckftp02 -e &quot;put $backup_file; exit&quot;; then
statusftp02=&quot;Echec de l'envoie FTP vers $bckftp02&quot;
else
statusftp02=&quot;Succes de l'envoie FTP vers $bckftp02&quot;
fi
#On log le resultat
logger -t backup &quot;$statusftp02&quot;

#Deplacer le fichier dans pydio
if ! mv $backup_file $destdir; then
statusmv=&quot;Warning : Echec du déplacement de $backup_file dans Pydio&quot;
else
statusmv=&quot;Fichier $backup_file déplacé dans Pydio&quot;
fi
logger -t backup &quot;$statusmv&quot;
logger -t backup &quot;########## Fin de la sauvegarde ##########&quot;
exit 0
</pre>
<p>Le script est planifié pour être lancé tous les dimanche à 5h00.
J'ai écris un 2nd script qui m'envoie un email avec les logs de la
sauvegarde afin que je puisse surveillé que tout c'est bien passé</p>
<pre class="literal-block">
#!/bin/bash
#Envoie d'un mail suite à l'execution du script de sauvegarde
datejour=$(LC_ALL=&quot;en_EN.UTF-8&quot; date &quot;+%b %d&quot;)
grep backup /var/log/messages |grep &quot;$datejour&quot; | mail -s &quot;Backup du mois de $(date &quot;+%B&quot;)&quot; adresse&#64;email.com adresse2&#64;email.com
</pre>
<p>Petite explication sur le LC_ALL=&quot;en_EN.UTF-8&quot;
Lorsque je tape</p>
<pre class="literal-block">
date &quot;+%b&quot;
</pre>
<p>J'obtiens la version courte et francisée du mois. Par exemple, pour le
mois de juillet, je vais avoir comme retour <em>juil</em>. Hors syslog lui
écris dans le fichier <em>/var/log/messages</em> en anglais. Ce qui donne pour
le mois de juillet : <em>jul</em> pour <em>july.</em> Pour pouvoir réussir mon grep
dans mon fichier de log, j'ai besoin de que la commande <em>date</em> me
retourne les informations en anglais également. C'est ce qui explique le
positionnement de cette variable en amont.</p>
<p>Ce second script est également placé dans un cron et est lancé a 5h15
tous les dimanches.</p>

                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="../../category/tech.html">Tech</a></p>
                        <p>Tags: <a href="../../tag/bash.html">bash</a>, <a href="../../tag/centos.html">centos</a>, <a href="../../tag/cron.html">cron</a>, <a href="../../tag/ftp.html">ftp</a>, <a href="../../tag/gz.html">gz</a>, <a href="../../tag/linux.html">Linux</a>, <a href="../../tag/pydio.html">pydio</a>, <a href="../../tag/sauvegarde.html">sauvegarde</a>, <a href="../../tag/script.html">script</a>, <a href="../../tag/tar.html">tar</a>, </p>
                    </aside>
                    <hr/>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="../../theme/js/main.js"></script>
    </body>
</html>