<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    Mise en oeuvre de Fail2Ban pour Owncloud/Ldap
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="../../theme/css/normalize.css">
        <link href='//fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="../../theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="../../theme/css/main.css">

    <link rel="stylesheet" href="../../theme/css/blog.css">
    <link rel="stylesheet" href="../../theme/css/github.css">
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Aldevar - Le Blog Atom Feed" />
        <script src="../../theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
        <a id="site-title" href="../.."><h1><i class="icon-coffee"></i> Aldevar - Le Blog</h1></a>
        <p id="site-desc"> Un Blog IT </p>
    </hgroup>
    <nav>
        <ul id="nav-links">
        </ul>
    </nav>
<footer id="site-info">
    <p>
        Proudly powered by <a href="http://getpelican.com/" target="pelican">Pelican</a> and <a href="http://python.org/" target="python">Python</a>. Theme by <a href="https://github.com/hdra/pelican-cait" target="github">hndr</a>.
    </p>
    <p>
        Textures by <a href="http://subtlepatterns.com/" target="subtlepatterns">Subtle Pattern</a>. Font Awesome by <a href="http://fortawesome.github.io/Font-Awesome/" target="github">Dave Grandy</a>.
    </p>
</footer></header>
    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <time class="post-time" datetime="2013-11-27T20:30:00+01:00" pubdate>
                            Wed 27 November 2013
                        </time>
                        <a href="../../2013/11/mise-en-oeuvre-de-fail2ban-pour-owncloudldap.html" rel="bookmark"><h1>Mise en oeuvre de Fail2Ban pour Owncloud/Ldap</h1></a>
                    </header>

                    <section class="post-content">
                        <p>Si vous stockez des données personnelles ou à caractères sensibles sur
votre serveur owncloud, vous souhaitez sans doute que les malandrins
s'aventurant à tester vos couples <em>Login / Mot de passe</em> par brutforce
soient éjectés de votre serveur après un certains nombre de tentatives
infructueuses.</p>
<p>Fail2Ban fera le travail pour vous, mais pour cela, il a besoin que les
échecs de connexions soient logués, ce qu'Owncloud ne fait
malheureusement pas. Il faut donc, avant de mettre en oeuvre Fail2Ban,
procéder à quelques modifications dans le code d'Owncloud.</p>
<p>Vous trouverez beaucoup d'article vous expliquant comment faire cela
avec une connexion classique via la base de donnée d'Owncloud, par
exemple
<a class="reference external" href="http://www.dataparadis.net/osp/gnu-linux-server/cloud-server/owncloud-and-fail2ban-update/">ici</a>.
Dans cet article, nous verrons plutôt comment régler le problème
lorsqu'on utilise une authentification via un serveur Ldap.</p>
<div class="section" id="preparer-le-terrain">
<h2>Préparer le terrain</h2>
<p>Afin d'assurer une cohérence dans l'écriture des logs, il faut que la
timezone soit correctement configurée sur le serveur. Vous pouvez faire
cela à l'aide de la commande :</p>
<pre class="literal-block">
[root&#64;server1]# tzselect
</pre>
<p>On va ensuite, créer le fichier qui servira à loguer les échecs de
connexions</p>
<pre class="literal-block">
[root&#64;server1]# touch /var/log/owncloud-fail.log
[root&#64;server1]# chmod 660 /var/log/owncloud-fail.log
[root&#64;server1]# chown root.apache&nbsp;/var/log/owncloud-fail.log
</pre>
</div>
<div class="section" id="modification-du-backend-d-owncloud">
<h2>Modification du backend d'Owncloud</h2>
<p>Dans le fichier lib/user/database.php, ligne 202. Dans la fonction
checkPassword, entre le <strong>else</strong> et le <strong>return false</strong>, insérez le code
suivant :</p>
<pre class="literal-block">
$today = new DateTime();
date_timezone_set($today, timezone_open('Europe/Paris'));
$IPClient=$_SERVER['REMOTE_ADDR'];
$logAuth=fopen('/var/log/owncloud-fail.log', 'a+');
fputs($logAuth, date_format($today, 'Y/m/d H:i:s') . &quot; Password check failed for: \t&quot; . $IPClient . &quot;\n&quot;);
fclose($logAuth);
</pre>
<p>Dans le fichier apps/user_ldap/user_ldap.php, ligne 75. Dans la
fonction checkPassword, entre le&nbsp; <strong>if(count($ldap_users) &lt; 1)
{</strong> et le&nbsp; <strong>return false;</strong> insérez le code suivant :</p>
<pre class="literal-block">
if($uid!=&quot;admin&quot;) {
date_default_timezone_set('Europe/Paris');
$today = date(&quot;Y/m/d H:i:s&quot;);
$IPClient=$_SERVER['REMOTE_ADDR'];
$logAuth=fopen('/var/log/owncloud-fail.log', 'a+');
fputs($logAuth, $today . &quot; Password check failed for: \t&quot; . $IPClient . &quot;\n&quot;);
fclose($logAuth);
</pre>
<p>Puis, en dessous du return false, fermez l'instruction if en ajoutant un</p>
<pre class="literal-block">
}
</pre>
<p><strong>Explication du code :</strong></p>
<p>Il y a un utilisateur qui est inscrit en base de donnée et qui n'est pas
dans le ldap, c'est l'admin d'owncloud. Afin ne ne pas loguer une
connexion de l'utilisateur 'admin' en tant qu'erreur de connexion, il
est nécessaire de vérifier que que c'est pas cet utilisateur qui se
connecte. D'où le <strong>if($uid!=&quot;admin&quot;){}</strong>. Veillez à modifier cette
valeur suivant la votre.</p>
<p>La variable <strong>$ldap_users</strong> est un tableau contenant la liste des
utilisateurs qui correspondent à la valeur saisie dans le login. Si
cette table est vide, alors il y aura un échec de connexion logué.</p>
<p>Le dernier ajout à faire se trouve un petit peu plus bas dans ce
fichier, ligne 97, juste en dessous
de&nbsp;<strong>if(!$this-&gt;areCredentialsValid($dn, $password)) {</strong> et au dessus
de <strong>return false;</strong>ajoutez le code suivant :</p>
<pre class="literal-block">
date_default_timezone_set('Europe/Paris');
$today = date(&quot;Y/m/d H:i:s&quot;);
$IPClient=$_SERVER['REMOTE_ADDR'];
$logAuth=fopen('/var/log/owncloud-fail.log', 'a+');
fputs($logAuth, $today . &quot; Password check failed for: \t&quot; . $IPClient . &quot;\n&quot;);
fclose($logAuth);
</pre>
</div>
<div class="section" id="configuration-de-fail2ban">
<h2>Configuration de Fail2Ban</h2>
<p>Dans votre fichier /etc/fail2ban/jail.conf (ou équivalent suivant votre
distribution) :</p>
<pre class="literal-block">
[Owncloud]
enabled  = true
port     = http,https
filter   = owncloud
logpath  = /var/log/owncloud-fail.log
maxretry = 5
</pre>
<p>Et enfin, le fichier de filtre /etc/fail2ban/filter.d/owncloud.conf</p>
<pre class="literal-block">
# /etc/fail2ban/filter.d/owncloud.conf
#
# Fail2Ban configuration file
# Owncloud
#

[Definition]
# Option: failregex
failregex = &lt;HOST&gt;$
</pre>
<p>Relancez fail2ban et le tour est joué.</p>
</div>

                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="../../category/tech.html">Tech</a></p>
                        <p>Tags: <a href="../../tag/fail2ban.html">fail2ban</a>, <a href="../../tag/ldap.html">ldap</a>, <a href="../../tag/linux.html">Linux</a>, <a href="../../tag/owncloud.html">owncloud</a>, </p>
                    </aside>
                    <hr/>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="../../theme/js/main.js"></script>
    </body>
</html>